# UtilsCompassSV - Copilot Instructions

This is an R package that provides utility functions for plotting and working with COMPASS (Combinatorial Polyfunctionality Analysis of Single Cells) output. The primary function is `plot_compass`, which creates concise visualizations of posterior probabilities for cytokine combinations.

## Repository Structure

- `R/`: Core R package source files
  - Main functions: `plot_compass.R`, `convert_cyt_combn_format.R`, `response_prob.R`
  - Helper functions: `plot_compass-save_layout.R`, `plot-compass-plot_compass_sub.R`, `get_col_vec_grp.R`
  - Utilities: `utils-pipe.R`
- `tests/testthat/`: Unit tests using testthat framework
  - Tests follow naming convention `test-<function_name>.R`
- `man/`: Auto-generated documentation (DO NOT edit manually)
- `data/`: Package data objects
- `data-raw/`: Scripts for creating test and example data
- `DESCRIPTION`: Package metadata and dependencies
- `NAMESPACE`: Auto-generated package namespace (DO NOT edit manually)
- `.github/workflows/`: CI/CD workflows

## Development Workflow

### Setup
Dependencies are managed through the DESCRIPTION file and installed automatically via `copilot-setup-steps.yml` during CI/CD.

### Building and Testing
```r
# Install dependencies (if needed manually)
install.packages("remotes")
remotes::install_deps(dependencies = TRUE)

# Load the package for development
devtools::load_all()

# Run tests
devtools::test()

# Check package (equivalent to R CMD check)
devtools::check()

# Build documentation
devtools::document()
```

### CI/CD
- The package uses `R-CMD-check` workflow which runs on push/PR to main/master branches
- Tests run on multiple OS (macOS, Windows, Ubuntu) and R versions (devel, release, oldrel-1)
- All commits must pass R CMD check before merging

## Code Standards

### R Package Conventions
1. **Documentation**: All exported functions must have roxygen2 documentation
   - Use `#'` for roxygen comments
   - Include `@title`, `@description`, `@param`, `@return`, `@export`, `@examples`
   - Run `devtools::document()` to update man/ files and NAMESPACE

2. **Function Naming**: Use snake_case for function names (e.g., `plot_compass`, `response_prob`)

3. **Dependencies**:
   - Use `::` notation to call functions from other packages (e.g., `purrr::map()`)
   - Add new dependencies to DESCRIPTION under `Imports:` (or `Suggests:` for test-only dependencies)
   - Avoid adding unnecessary dependencies

4. **Code Style**:
   - Follow tidyverse style guide
   - Use explicit returns with `return()` when function logic is complex
   - Use pipe operator `%>%` (imported via magrittr) for data transformation chains

5. **Testing**:
   - Write tests for all exported functions
   - Use testthat 3rd edition (`testthat (>= 3.0.0)`)
   - Test files should be named `test-<function_name>.R`
   - Use descriptive test names: `test_that("function_name does expected behavior", { ... })`
   - Tests should be self-contained and clean up any temporary files created

### Package-Specific Guidelines

1. **COMPASS Integration**: This package works with COMPASS output objects
   - Maintain compatibility with COMPASS::COMPASSResult class
   - Handle both single COMPASSResult objects and lists of such objects

2. **Plotting Functions**:
   - Use ggplot2 for visualizations
   - Support saving plots in both PNG and PDF formats
   - Provide sensible defaults but allow customization
   - Handle edge cases (empty data, missing combinations, etc.)

3. **Cytokine Combinations**:
   - Support both "standard" (+/-) and COMPASS (!&) formats
   - Maintain consistent cytokine ordering across visualizations

4. **Data Handling**:
   - Use tidyverse packages (purrr, tibble, tidyr, stringr) for data manipulation
   - Handle missing or malformed data gracefully with informative error messages

## Important Notes

- **DO NOT** manually edit `man/` directory files - these are auto-generated by roxygen2
- **DO NOT** manually edit `NAMESPACE` - it's auto-generated by roxygen2
- **DO NOT** commit files listed in `.Rbuildignore` (like README.Rmd, data-raw/*, .Rproj files)
- The package uses lazy data loading (`LazyData: true`), so data objects are loaded on demand
- Minimum R version requirement: R >= 2.10
- RoxygenNote version: 7.1.2

## Testing Best Practices

- Test files use temporary directories (`tempdir()`) for file operations
- Clean up test artifacts after tests complete
- Use `data("dataset_name", package = "UtilsCompassSV")` to load package data in tests
- Test both success cases and expected failures/edge cases
- Use `expect_*` functions from testthat appropriately

## Version Management

- Version is stored in DESCRIPTION file (current: 0.1.6)
- Follow semantic versioning when incrementing versions
- Update NEWS.md (if exists) when making user-facing changes
